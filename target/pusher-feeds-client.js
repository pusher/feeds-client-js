!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Feeds=t()}(this,function(){"use strict";"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var e,t,n=(function(e,t){var n;n=function(){return function(n){var r={};function o(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}return o.m=n,o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=9)}([function(e,t,n){function r(e){var t={};if(!e)return t;for(var n=0,r=e.split("\r\n");n<r.length;n++){var o=r[n],i=o.indexOf(": ");if(0<i){var s=o.substring(0,i),a=o.substring(i+2);t[s]=a}}return t}Object.defineProperty(t,"__esModule",{value:!0}),t.responseToHeadersObject=r;var o=function(){function t(e,t,n){this.statusCode=e,this.headers=t,this.info=n}return t.fromXHR=function(e){return new t(e.status,r(e.getAllResponseHeaders()),e.responseText)},t}();t.ErrorResponse=o;var i,s=function(e){this.error=e};t.NetworkError=s,(i=t.XhrReadyState||(t.XhrReadyState={}))[i.UNSENT=0]="UNSENT",i[i.OPENED=1]="OPENED",i[i.HEADERS_RECEIVED=2]="HEADERS_RECEIVED",i[i.LOADING=3]="LOADING",i[i.DONE=4]="DONE"},function(e,t,n){var i,r;Object.defineProperty(t,"__esModule",{value:!0}),(r=i=t.LogLevel||(t.LogLevel={}))[r.VERBOSE=1]="VERBOSE",r[r.DEBUG=2]="DEBUG",r[r.INFO=3]="INFO",r[r.WARNING=4]="WARNING",r[r.ERROR=5]="ERROR";var o=function(){function e(e){void 0===e&&(e=2),this.threshold=e;var t=Array(),n="--------------------------------------------------------------------------------";window.console.group||(window.console.group=function(e){t.push(e),window.console.log("%c \nBEGIN GROUP: %c",n,e)}),window.console.groupEnd||(window.console.groupEnd=function(){window.console.log("END GROUP: %c\n%c",t.pop(),n)})}return e.prototype.verbose=function(e,t){this.log(window.console.log,i.VERBOSE,e,t)},e.prototype.debug=function(e,t){this.log(window.console.log,i.DEBUG,e,t)},e.prototype.info=function(e,t){this.log(window.console.info,i.INFO,e,t)},e.prototype.warn=function(e,t){this.log(window.console.warn,i.WARNING,e,t)},e.prototype.error=function(e,t){this.log(window.console.error,i.ERROR,e,t)},e.prototype.log=function(e,t,n,r){if(t>=this.threshold){var o="Logger."+i[t];r?(window.console.group(),e(o+": "+n),e(r),window.console.groupEnd()):e(o+": "+n)}},e}();t.ConsoleLogger=o;var s=function(){function e(){}return e.prototype.verbose=function(e,t){},e.prototype.debug=function(e,t){},e.prototype.info=function(e,t){},e.prototype.warn=function(e,t){},e.prototype.error=function(e,t){},e}();t.EmptyLogger=s},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0);t.createRetryStrategyOptionsOrDefault=function(e){var t=e.initialTimeoutMillis||1e3,n=e.maxTimeoutMillis||5e3,r=-1;return void 0!==e.limit&&null!=e.limit&&(r=e.limit),{increaseTimeout:void 0!==e.increaseTimeout?e.increaseTimeout:function(e){return n<2*e?n:2*e},initialTimeoutMillis:t,limit:r,maxTimeoutMillis:n}};var o=function(e){this.waitTimeMillis=e};t.Retry=o;var i=function(e){this.error=e};t.DoNotRetry=i;var s=function(){function e(e,t,n){this.options=e,this.logger=t,this.retryUnsafeRequests=n,this.currentRetryCount=0,this.initialTimeoutMillis=e.initialTimeoutMillis,this.maxTimeoutMillis=e.maxTimeoutMillis,this.limit=e.limit,this.increaseTimeoutFunction=e.increaseTimeout,this.currentBackoffMillis=this.initialTimeoutMillis}return e.prototype.attemptRetry=function(e){return this.logger.verbose(this.constructor.name+":  Error received",e),this.currentRetryCount>=this.limit&&0<=this.limit?(this.logger.verbose(this.constructor.name+":  Retry count is over the maximum limit: "+this.limit),new i(e)):e instanceof r.ErrorResponse&&e.headers["Retry-After"]?(this.logger.verbose(this.constructor.name+":  Retry-After header is present, retrying in "+e.headers["Retry-After"]),new o(1e3*parseInt(e.headers["Retry-After"],10))):e instanceof r.NetworkError||e instanceof r.ErrorResponse&&("GET"===(t=(t=e.headers["Request-Method"]).toUpperCase())||"HEAD"===t||"OPTIONS"===t||"SUBSCRIBE"===t)||this.retryUnsafeRequests?this.shouldSafeRetry(e):e instanceof r.NetworkError?this.shouldSafeRetry(e):(this.logger.verbose(this.constructor.name+": Error is not retryable",e),new i(e));var t},e.prototype.shouldSafeRetry=function(e){return e instanceof r.NetworkError?(this.logger.verbose(this.constructor.name+": It's a Network Error, will retry",e),new o(this.calulateMillisToRetry())):e instanceof r.ErrorResponse&&500<=e.statusCode&&e.statusCode<600?(this.logger.verbose(this.constructor.name+": Error 5xx, will retry"),new o(this.calulateMillisToRetry())):(this.logger.verbose(this.constructor.name+": Error is not retryable",e),new i(e))},e.prototype.calulateMillisToRetry=function(){return this.currentBackoffMillis=this.increaseTimeoutFunction(this.currentBackoffMillis),this.logger.verbose(this.constructor.name+": Retrying in "+this.currentBackoffMillis+"ms"),this.currentBackoffMillis},e}();t.RetryResolution=s},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),o=n(4),h=n(5),c=n(6),p=n(10),l=n(11),d=n(7),i=n(12),s=n(13),f=n(8),a=function(){function e(e){this.options=e,this.host=e.host.replace(/(\/)+$/,""),this.logger=e.logger||new r.ConsoleLogger,this.websocketTransport=new s.default(this.host),this.httpTransport=new i.default(this.host)}return e.prototype.request=function(n,e){var r=this;return n.tokenProvider?n.tokenProvider.fetchToken(e).then(function(e){return void 0!==n.headers?n.headers.Authorization="Bearer "+e:n.headers=((t={}).Authorization="Bearer "+e,t),o.executeNetworkRequest(function(){return r.httpTransport.request(n)},n);var t}).catch(function(e){r.logger.error(e)}):o.executeNetworkRequest(function(){return r.httpTransport.request(n)},n)},e.prototype.subscribeResuming=function(e,t,n,r,o,i){var s=l.replaceMissingListenersWithNoOps(n),a=p.subscribeStrategyListenersFromSubscriptionListeners(s),u=h.createResumingStrategy(r,d.createTokenProvidingStrategy(f.createTransportStrategy(e,this.websocketTransport,this.logger),this.logger,i),this.logger,o),c=!1;return u({onEnd:a.onEnd,onError:a.onError,onEvent:a.onEvent,onOpen:function(e){c||(c=!0,a.onOpen(e)),s.onSubscribe()},onRetrying:a.onRetrying},t)},e.prototype.subscribeNonResuming=function(e,t,n,r,o){var i=l.replaceMissingListenersWithNoOps(n),s=p.subscribeStrategyListenersFromSubscriptionListeners(i),a=c.createRetryingStrategy(r,d.createTokenProvidingStrategy(f.createTransportStrategy(e,this.websocketTransport,this.logger),this.logger,o),this.logger),u=!1;return a({onEnd:s.onEnd,onError:s.onError,onEvent:s.onEvent,onOpen:function(e){u||(u=!0,s.onOpen(e)),i.onSubscribe()},onRetrying:s.onRetrying},t)},e}();t.BaseClient=a},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(0);t.executeNetworkRequest=function(r,o){return new Promise(function(e,t){var n=r();n.onreadystatechange=function(){4===n.readyState&&(200<=n.status&&n.status<300?e(n.response):0!==n.status?t(i.ErrorResponse.fromXHR(n)):t(new i.NetworkError("No Connection")))},n.send(JSON.stringify(o.body))})}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var g=n(0),b=n(2);t.createResumingStrategy=function(e,l,d,i){var t=b.createRetryStrategyOptionsOrDefault(e),f=new b.RetryResolution(t,d),n=function(a,u){var t=this;this.unsubscribe=function(){t.state.unsubscribe()},this.onTransition=function(e){t.state=e};var e=function(){function e(t){var n=this;this.onTransition=t;var r=i;d.verbose("ResumingSubscription: transitioning to OpeningSubscriptionState"),r&&(u["Last-Event-Id"]=r,d.verbose("ResumingSubscription: initialEventId is "+r)),this.underlyingSubscription=l({onEnd:function(e){t(new h(e))},onError:function(e){t(new o(e,t,r))},onEvent:function(e){r=e.eventId,a.onEvent(e)},onOpen:function(e){t(new c(e,n.underlyingSubscription,t))},onRetrying:a.onRetrying},u)}return e.prototype.unsubscribe=function(){this.onTransition(new n),this.underlyingSubscription.unsubscribe()},e}(),c=function(){function e(e,t,n){this.underlyingSubscription=t,this.onTransition=n,d.verbose("ResumingSubscription: transitioning to OpenSubscriptionState"),a.onOpen(e)}return e.prototype.unsubscribe=function(){this.onTransition(new n),this.underlyingSubscription.unsubscribe()},e}(),o=function(){function e(e,o,t){var i=this;this.onTransition=o,d.verbose("ResumingSubscription: transitioning to ResumingSubscriptionState");var n=function(e,t){a.onRetrying();var n,r=((n=e)instanceof g.ErrorResponse&&(n.headers["Request-Method"]="SUBSCRIBE"),f.attemptRetry(n));r instanceof b.Retry?i.timeout=window.setTimeout(function(){s(t)},r.waitTimeMillis):o(new p(e))},s=function(t){d.verbose("ResumingSubscription: trying to re-establish the subscription"),t&&(d.verbose("ResumingSubscription: lastEventId: "+t),u["Last-Event-Id"]=t),i.underlyingSubscription=l({onEnd:function(e){o(new h(e))},onError:function(e){n(e,t)},onEvent:function(e){t=e.eventId,a.onEvent(e)},onOpen:function(e){o(new c(e,i.underlyingSubscription,o))},onRetrying:a.onRetrying},u)};n(e,t)}return e.prototype.unsubscribe=function(){this.onTransition(new n),window.clearTimeout(this.timeout),this.underlyingSubscription.unsubscribe()},e}(),n=function(){function e(e){d.verbose("ResumingSubscription: transitioning to EndingSubscriptionState")}return e.prototype.unsubscribe=function(){throw new Error("Subscription is already ending")},e}(),h=function(){function e(e){d.verbose("ResumingSubscription: transitioning to EndedSubscriptionState"),a.onEnd(e)}return e.prototype.unsubscribe=function(){throw new Error("Subscription has already ended")},e}(),p=function(){function e(e){d.verbose("ResumingSubscription: transitioning to FailedSubscriptionState",e),a.onError(e)}return e.prototype.unsubscribe=function(){throw new Error("Subscription has already ended")},e}();this.state=new e(this.onTransition)};return function(e,t){return new n(e,t)}}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var f=n(0),g=n(2);t.createRetryingStrategy=function(e,p,l){var t=g.createRetryStrategyOptionsOrDefault(e),d=new g.RetryResolution(t,l),n=function(s,a){var t=this;this.unsubscribe=function(){t.state.unsubscribe()},this.onTransition=function(e){t.state=e};var e=function(){function e(t){var n=this;l.verbose("RetryingSubscription: transitioning to OpeningSubscriptionState"),this.underlyingSubscription=p({onEnd:function(e){return t(new c(e))},onError:function(e){return t(new r(e,t))},onEvent:s.onEvent,onOpen:function(e){return t(new u(e,n.underlyingSubscription,t))},onRetrying:s.onRetrying},a)}return e.prototype.unsubscribe=function(){throw this.underlyingSubscription.unsubscribe(),new Error("Method not implemented.")},e}(),r=function(){function e(e,r){var o=this;this.onTransition=r,l.verbose("RetryingSubscription: transitioning to RetryingSubscriptionState");var n=function(e){s.onRetrying();var t,n=((t=e)instanceof f.ErrorResponse&&(t.headers["Request-Method"]="SUBSCRIBE"),d.attemptRetry(t));n instanceof g.Retry?o.timeout=window.setTimeout(function(){i()},n.waitTimeMillis):r(new h(e))},i=function(){l.verbose("RetryingSubscription: trying to re-establish the subscription");var t=p({onEnd:function(e){return r(new c(e))},onError:function(e){return n(e)},onEvent:s.onEvent,onOpen:function(e){r(new u(e,t,r))},onRetrying:s.onRetrying},a)};n(e)}return e.prototype.unsubscribe=function(){window.clearTimeout(this.timeout),this.onTransition(new c)},e}(),u=function(){function e(e,t,n){this.underlyingSubscription=t,this.onTransition=n,l.verbose("RetryingSubscription: transitioning to OpenSubscriptionState"),s.onOpen(e)}return e.prototype.unsubscribe=function(){this.underlyingSubscription.unsubscribe(),this.onTransition(new c)},e}(),c=function(){function e(e){l.verbose("RetryingSubscription: transitioning to EndedSubscriptionState"),s.onEnd(e)}return e.prototype.unsubscribe=function(){throw new Error("Subscription has already ended")},e}(),h=function(){function e(e){l.verbose("RetryingSubscription: transitioning to FailedSubscriptionState",e),s.onError(e)}return e.prototype.unsubscribe=function(){throw new Error("Subscription has already ended")},e}();this.state=new e(this.onTransition)};return function(e,t){return new n(e,t)}}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0);t.createTokenProvidingStrategy=function(n,r,o){return o?function(e,t){return new i(r,e,t,o,n)}:n};var i=function(){function e(e,t,n,r,o){var i=this;this.logger=e,this.listeners=t,this.headers=n,this.tokenProvider=r,this.nextSubscribeStrategy=o,this.unsubscribe=function(){i.state.unsubscribe(),i.state=new a(i.logger)},this.state=new s(e,n,o),this.subscribe()}return e.prototype.subscribe=function(){var r=this;this.tokenProvider.fetchToken().then(function(t){var n=Object.assign({},r.listeners);r.state.subscribe(t,{onEnd:function(e){r.state=new a(r.logger),n.onEnd(e)},onError:function(e){r.isTokenExpiredError(e)?(r.tokenProvider.clearToken(t),r.subscribe()):(r.state=new a(r.logger),n.onError(e))},onEvent:r.listeners.onEvent,onOpen:r.listeners.onOpen})}).catch(function(e){r.logger.debug("TokenProvidingSubscription: error when fetching token: "+e),r.state=new a(r.logger)})},e.prototype.isTokenExpiredError=function(e){return e instanceof r.ErrorResponse&&401===e.statusCode&&"authentication/expired"===e.info},e}(),s=function(){function e(e,t,n){this.logger=e,this.headers=t,this.nextSubscribeStrategy=n,e.verbose("TokenProvidingSubscription: transitioning to TokenProvidingState")}return e.prototype.subscribe=function(e,t){var n=this;this.putTokenIntoHeader(e),this.underlyingSubscription=this.nextSubscribeStrategy({onEnd:function(e){n.logger.verbose("TokenProvidingSubscription: subscription ended"),t.onEnd(e)},onError:function(e){n.logger.verbose("TokenProvidingSubscription: subscription errored: "+e),t.onError(e)},onEvent:t.onEvent,onOpen:function(e){n.logger.verbose("TokenProvidingSubscription: subscription opened"),t.onOpen(e)},onRetrying:t.onRetrying},this.headers)},e.prototype.unsubscribe=function(){this.underlyingSubscription.unsubscribe()},e.prototype.putTokenIntoHeader=function(e){this.headers.Authorization="Bearer "+e,this.logger.verbose("TokenProvidingSubscription: token fetched: "+e)},e}(),a=function(){function e(e){(this.logger=e).verbose("TokenProvidingSubscription: transitioning to OpenTokenProvidingSubscriptionState")}return e.prototype.subscribe=function(e,t){this.logger.verbose("TokenProvidingSubscription: subscribe called in Inactive state; doing nothing")},e.prototype.unsubscribe=function(){this.logger.verbose("TokenProvidingSubscription: unsubscribe called in Inactive state; doing nothing")},e}()},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.createTransportStrategy=function(n,r,e){return function(e,t){return r.subscribe(n,e,t)}}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(3);t.BaseClient=r.BaseClient;var o=n(14);t.Instance=o.default;var i=n(1);t.ConsoleLogger=i.ConsoleLogger,t.EmptyLogger=i.EmptyLogger;var s=n(0);t.ErrorResponse=s.ErrorResponse,t.NetworkError=s.NetworkError,t.responseToHeadersObject=s.responseToHeadersObject,t.XhrReadyState=s.XhrReadyState;var a=n(4);t.executeNetworkRequest=a.executeNetworkRequest;var u=n(5);t.createResumingStrategy=u.createResumingStrategy;var c=n(2);t.createRetryStrategyOptionsOrDefault=c.createRetryStrategyOptionsOrDefault,t.DoNotRetry=c.DoNotRetry,t.Retry=c.Retry,t.RetryResolution=c.RetryResolution;var h=n(6);t.createRetryingStrategy=h.createRetryingStrategy;var p=n(7);t.createTokenProvidingStrategy=p.createTokenProvidingStrategy;var l=n(8);t.createTransportStrategy=l.createTransportStrategy,t.default={BaseClient:r.BaseClient,ConsoleLogger:i.ConsoleLogger,EmptyLogger:i.EmptyLogger,Instance:o.default}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.subscribeStrategyListenersFromSubscriptionListeners=function(e){return{onEnd:e.onEnd,onError:e.onError,onEvent:e.onEvent,onOpen:e.onOpen,onRetrying:e.onRetrying}}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.replaceMissingListenersWithNoOps=function(e){return{onEnd:e.onEnd||function(e){},onError:e.onError||function(e){},onEvent:e.onEvent||function(e){},onOpen:e.onOpen||function(e){},onRetrying:e.onRetrying||function(){},onSubscribe:e.onSubscribe||function(){}}}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var u,r,o=n(0);(r=u=t.HttpTransportState||(t.HttpTransportState={}))[r.UNOPENED=0]="UNOPENED",r[r.OPENING=1]="OPENING",r[r.OPEN=2]="OPEN",r[r.ENDING=3]="ENDING",r[r.ENDED=4]="ENDED";var i=function(){function e(e,t){var n=this;return this.gotEOS=!1,this.lastNewlineIndex=0,this.state=u.UNOPENED,this.xhr=e,this.listeners=t,this.xhr.onreadystatechange=function(){switch(n.xhr.readyState){case o.XhrReadyState.UNSENT:case o.XhrReadyState.OPENED:case o.XhrReadyState.HEADERS_RECEIVED:n.assertStateIsIn(u.OPENING);break;case o.XhrReadyState.LOADING:n.onLoading();break;case o.XhrReadyState.DONE:n.onDone()}},this.state=u.OPENING,this.xhr.send(),this}return e.prototype.unsubscribe=function(){this.state=u.ENDED,this.xhr.abort(),this.listeners.onEnd&&this.listeners.onEnd(null)},e.prototype.onLoading=function(){if(this.assertStateIsIn(u.OPENING,u.OPEN,u.ENDING),200===this.xhr.status){this.state===u.OPENING&&(this.state=u.OPEN,window.console.log(o.responseToHeadersObject(this.xhr.getAllResponseHeaders())),this.listeners.onOpen&&this.listeners.onOpen(o.responseToHeadersObject(this.xhr.getAllResponseHeaders()))),this.assertStateIsIn(u.OPEN);var e=this.onChunk();this.assertStateIsIn(u.OPEN,u.ENDING),e&&(this.state=u.ENDED,e instanceof o.ErrorResponse&&204!==e.statusCode&&this.listeners.onError&&this.listeners.onError(e))}},e.prototype.onDone=function(){if(200===this.xhr.status){this.state===u.OPENING&&(this.state=u.OPEN,this.listeners.onOpen&&this.listeners.onOpen(o.responseToHeadersObject(this.xhr.getAllResponseHeaders()))),this.assertStateIsIn(u.OPEN,u.ENDING);var e=this.onChunk();e?(this.state=u.ENDED,204===e.statusCode?this.listeners.onEnd&&this.listeners.onEnd(null):this.listeners.onError&&this.listeners.onError(e)):this.state<=u.ENDING?this.listeners.onError&&this.listeners.onError(new Error("HTTP response ended without receiving EOS message")):this.listeners.onEnd&&this.listeners.onEnd(null)}else{if(this.assertStateIsIn(u.OPENING,u.OPEN,u.ENDED),this.state===u.ENDED)return;0===this.xhr.status?this.listeners.onError&&this.listeners.onError(new o.NetworkError("Connection lost.")):this.listeners.onError&&this.listeners.onError(o.ErrorResponse.fromXHR(this.xhr))}},e.prototype.onChunk=function(){this.assertStateIsIn(u.OPEN);var e=this.xhr.responseText,t=e.lastIndexOf("\n");if(t>this.lastNewlineIndex){var n=e.slice(this.lastNewlineIndex,t).split("\n");this.lastNewlineIndex=t;for(var r=0,o=n;r<o.length;r++){var i=o[r];if(0!==i.length){var s=JSON.parse(i),a=this.onMessage(s);if(null!=a)return a}}}},e.prototype.assertStateIsIn=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];if(!e.some(function(e){return e===t.state})){var r=e.map(function(e){return u[e]}).join(", "),o=u[this.state];window.console.warn("Expected this.state to be one of ["+r+"] but it is "+o)}},e.prototype.onMessage=function(e){switch(this.assertStateIsIn(u.OPEN),this.verifyMessage(e),e[0]){case 0:return null;case 1:return this.onEventMessage(e);case 255:return this.onEOSMessage(e);default:return new Error("Unknown Message: "+JSON.stringify(e))}},e.prototype.onEventMessage=function(e){if(this.assertStateIsIn(u.OPEN),4!==e.length)return new Error("Event message has "+e.length+" elements (expected 4)");e[0];var t=e[1],n=e[2],r=e[3];return"string"!=typeof t?new Error("Invalid event ID in message: "+JSON.stringify(e)):"object"!=typeof n||Array.isArray(n)?new Error("Invalid event headers in message: "+JSON.stringify(e)):(this.listeners.onEvent&&this.listeners.onEvent({body:r,headers:n,eventId:t}),null)},e.prototype.onEOSMessage=function(e){if(this.assertStateIsIn(u.OPEN),4!==e.length)return new Error("EOS message has "+e.length+" elements (expected 4)");e[0];var t=e[1],n=e[2],r=e[3];return"number"!=typeof t?new Error("Invalid EOS Status Code"):"object"!=typeof n||Array.isArray(n)?new Error("Invalid EOS ElementsHeaders"):(this.state=u.ENDING,new o.ErrorResponse(t,n,r))},e.prototype.verifyMessage=function(e){return this.gotEOS?new Error("Got another message after EOS message"):Array.isArray(e)?e.length<1?new Error("Message is empty array"):void 0:new Error("Message is not an array")},e}(),s=function(){function e(e,t){this.baseURL=(!1!==t?"https":"http")+"://"+e}return e.prototype.request=function(e){return this.createXHR(this.baseURL,e)},e.prototype.subscribe=function(e,t,n){var r={headers:n,method:"SUBSCRIBE",path:e};return new i(this.createXHR(this.baseURL,r),t)},e.prototype.createXHR=function(e,t){var n=new window.XMLHttpRequest,r=e+"/"+t.path.replace(/^\/+/,"");if(n.open(t.method.toUpperCase(),r,!0),t.body&&n.setRequestHeader("content-type","application/json"),t.jwt&&n.setRequestHeader("authorization","Bearer "+t.jwt),t.headers)for(var o in t.headers)t.headers.hasOwnProperty(o)&&n.setRequestHeader(o,t.headers[o]);return n},e}();t.default=s},function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e};Object.defineProperty(t,"__esModule",{value:!0});var o,i,s=n(0);(i=o=t.WSReadyState||(t.WSReadyState={}))[i.Connecting=0]="Connecting",i[i.Open=1]="Open",i[i.Closing=2]="Closing",i[i.Closed=3]="Closed";var a=function(){function e(){this.subscriptions={}}return e.prototype.add=function(e,t,n,r){return this.subscriptions[e]={headers:r,listeners:n,path:t},e},e.prototype.has=function(e){return void 0!==this.subscriptions[e]},e.prototype.isEmpty=function(){return 0===Object.keys(this.subscriptions).length},e.prototype.remove=function(e){return delete this.subscriptions[e]},e.prototype.get=function(e){return this.subscriptions[e]},e.prototype.getAll=function(){return this.subscriptions},e.prototype.getAllAsArray=function(){var t=this;return Object.keys(this.subscriptions).map(function(e){return r({subID:parseInt(e,10)},t.subscriptions[parseInt(e,10)])})},e.prototype.removeAll=function(){this.subscriptions={}},e}(),u=function(){function e(e,t){this.wsTransport=e,this.subID=t}return e.prototype.unsubscribe=function(){this.wsTransport.unsubscribe(this.subID)},e}(),c=function(){function e(e){this.webSocketPath="/ws",this.forcedClose=!1,this.closedError=null,this.baseURL="wss://"+e+this.webSocketPath,this.lastSubscriptionID=0,this.subscriptions=new a,this.pendingSubscriptions=new a,this.connect()}return e.prototype.subscribe=function(e,t,n){this.tryReconnectIfNeeded();var r=this.lastSubscriptionID++;return this.socket.readyState!==o.Open?this.pendingSubscriptions.add(r,e,t,n):(this.subscriptions.add(r,e,t,n),this.sendMessage(this.getMessage(100,r,e,n))),new u(this,r)},e.prototype.unsubscribe=function(e){this.sendMessage(this.getMessage(198,e));var t=this.subscriptions.get(e);t.listeners.onEnd&&t.listeners.onEnd(null),this.subscriptions.remove(e)},e.prototype.connect=function(){var i=this;this.close(),this.forcedClose=!1,this.closedError=null,this.socket=new window.WebSocket(this.baseURL),this.socket.onopen=function(e){i.pendingSubscriptions.getAllAsArray().forEach(function(e){var t=e.subID,n=e.path,r=e.listeners,o=e.headers;i.subscribePending(n,r,o,t)}),i.pendingSubscriptions.removeAll(),i.pingInterval=window.setInterval(function(){if(!i.pongTimeout){var e=(new Date).getTime();e-i.lastMessageReceivedTimestamp<1e4||(i.sendMessage(i.getMessage(16,e)),i.lastSentPingID=e,i.pongTimeout=window.setTimeout(function(){(new Date).getTime()-i.lastMessageReceivedTimestamp<1e4?i.pongTimeout=null:i.close(new s.NetworkError("Pong response wasn't received until timeout."))},1e4))}},3e4)},this.socket.onmessage=function(e){return i.receiveMessage(e)},this.socket.onerror=function(e){i.close(new s.NetworkError("Connection was lost."))},this.socket.onclose=function(e){if(i.forcedClose){var t=i.closedError?function(e){e.listeners.onError&&e.listeners.onError(i.closedError)}:function(e){e.listeners.onEnd&&e.listeners.onEnd(null)},n=!1===i.pendingSubscriptions.isEmpty()?i.pendingSubscriptions:i.subscriptions;n.getAllAsArray().forEach(t),n.removeAll(),i.closedError&&i.tryReconnectIfNeeded()}else i.tryReconnectIfNeeded()}},e.prototype.close=function(e){this.socket instanceof window.WebSocket&&(this.forcedClose=!0,this.closedError=e,this.socket.close(),window.clearTimeout(this.pingInterval),window.clearTimeout(this.pongTimeout),delete this.pongTimeout,this.lastSentPingID=null)},e.prototype.tryReconnectIfNeeded=function(){this.socket.readyState===o.Closed&&this.connect()},e.prototype.subscribePending=function(e,t,n,r){void 0!==r?(this.subscriptions.add(r,e,t,n),this.sendMessage(this.getMessage(100,r,e,n))):window.console.logger.debug("Subscription to path "+e+" has an undefined ID")},e.prototype.getMessage=function(e,t,n,r){return[e,t,n,r]},e.prototype.sendMessage=function(e){if(this.socket.readyState!==o.Open)return window.console.warn("Can't send in \""+o[this.socket.readyState]+'" state');this.socket.send(JSON.stringify(e))},e.prototype.subscription=function(e){return this.subscriptions.get(e)},e.prototype.receiveMessage=function(t){var e;this.lastMessageReceivedTimestamp=(new Date).getTime();try{e=JSON.parse(t.data)}catch(e){return void this.close(new Error("Message is not valid JSON format. Getting "+t.data))}var n=this.validateMessage(e);if(n)this.close(new Error(n.message));else{var r=e.shift();switch(r){case 17:return void this.onPongMessage(e);case 16:return void this.onPingMessage(e);case 99:return void this.onCloseMessage(e)}var o=e.shift(),i=this.subscription(o);if(i){var s=i.listeners;switch(r){case 101:this.onOpenMessage(e,o,s);break;case 102:this.onEventMessage(e,s);break;case 199:this.onEOSMessage(e,o,s);break;default:this.close(new Error("Received non existing type of message."))}}else this.close(new Error('Received message for non existing subscription id: "'+o+'"'))}},e.prototype.validateMessage=function(e){return Array.isArray(e)?e.length<1?new Error("Message is empty array: "+JSON.stringify(e)):null:new Error("Message is expected to be an array. Getting: "+JSON.stringify(e))},e.prototype.onOpenMessage=function(e,t,n){n.onOpen&&n.onOpen(e[1])},e.prototype.onEventMessage=function(e,t){if(3!==e.length)return new Error("Event message has "+e.length+" elements (expected 4)");var n=e[0],r=e[1],o=e[2];return"string"!=typeof n?new Error("Invalid event ID in message: "+JSON.stringify(e)):"object"!=typeof r||Array.isArray(r)?new Error("Invalid event headers in message: "+JSON.stringify(e)):void(t.onEvent&&t.onEvent({eventId:n,headers:r,body:o}))},e.prototype.onEOSMessage=function(e,t,n){if(this.subscriptions.remove(t),3===e.length){var r=e[0],o=e[1],i=e[2];"number"==typeof r?"object"!=typeof o||Array.isArray(o)?n.onError&&n.onError(new Error("Invalid EOS ElementsHeaders")):204!==r?n.onError&&n.onError(new s.ErrorResponse(r,o,i)):n.onEnd&&n.onEnd(null):n.onError&&n.onError(new Error("Invalid EOS Status Code"))}else n.onError&&n.onError(new Error("EOS message has "+e.length+" elements (expected 4)"))},e.prototype.onCloseMessage=function(e){var t=e[0],n=e[1];e[2];return"number"!=typeof t?this.close(new Error("Close message: Invalid EOS Status Code")):"object"!=typeof n||Array.isArray(n)?this.close(new Error("Close message: Invalid EOS ElementsHeaders")):void this.close()},e.prototype.onPongMessage=function(e){var t=e[0];this.lastSentPingID!==t&&this.close(new s.NetworkError("Didn't received pong with proper ID")),window.clearTimeout(this.pongTimeout),delete this.pongTimeout,this.lastSentPingID=null},e.prototype.onPingMessage=function(e){var t=e[0];this.sendMessage(this.getMessage(17,t))},e}();t.default=c},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),o=n(1),i=function(){function e(e){if(!e.locator)throw new Error("Expected `locator` property in Instance options!");if(3!==e.locator.split(":").length)throw new Error("The instance locator property is in the wrong format!");if(!e.serviceName)throw new Error("Expected `serviceName` property in Instance options!");if(!e.serviceVersion)throw new Error("Expected `serviceVersion` property in Instance otpions!");var t=e.locator.split(":");this.platformVersion=t[0],this.cluster=t[1],this.id=t[2],this.serviceName=e.serviceName,this.serviceVersion=e.serviceVersion,this.host=e.host||this.cluster+".pusherplatform.io",this.logger=e.logger||new o.ConsoleLogger,this.client=e.client||new r.BaseClient({encrypted:e.encrypted,host:this.host,logger:this.logger}),this.tokenProvider=e.tokenProvider}return e.prototype.request=function(e,t){return e.path=this.absPath(e.path),null!=e.headers&&void 0!==e.headers||(e.headers={}),e.tokenProvider=e.tokenProvider||this.tokenProvider,this.client.request(e,t)},e.prototype.subscribeNonResuming=function(e){var t=e.headers||{},n=e.retryStrategyOptions||{},r=e.tokenProvider||this.tokenProvider;return this.client.subscribeNonResuming(this.absPath(e.path),t,e.listeners,n,r)},e.prototype.subscribeResuming=function(e){var t=e.headers||{},n=e.retryStrategyOptions||{},r=e.tokenProvider||this.tokenProvider;return this.client.subscribeResuming(this.absPath(e.path),t,e.listeners,n,e.initialEventId,r)},e.prototype.absPath=function(e){return("/services/"+this.serviceName+"/"+this.serviceVersion+"/"+this.id+"/"+e).replace(/\/+/g,"/").replace(/\/+$/,"")},e}();t.default=i}])},e.exports=n()}(e={exports:{}},e.exports),e.exports),c=(t=n)&&t.__esModule?t.default:t;function i(e){return new Promise(function(t,n){e.then(function(e){try{t(JSON.parse(e))}catch(e){n(e)}}).catch(n)})}function o(t){return Object.keys(t).filter(function(e){return void 0!==t[e]}).map(function(e){return e+"="+encodeURIComponent(t[e])}).join("&")}function s(e){var t=o(e);return t?"?"+t:""}function a(){return Math.floor(Date.now()/1e3)}var h=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},p=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),l=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},d=function(e,t){var n={};for(var r in e)0<=t.indexOf(r)||Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n},r=function(){function o(e){var t=e.instance,n=e.feedId,r=e.readTokenProvider;h(this,o),this.instance=t,this.feedId=n,this.readTokenProvider=r}return p(o,[{key:"subscribe",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.onOpen,n=e.onItem,r=d(e,["onOpen","onItem"]);if(t&&"function"!=typeof t)throw new TypeError("onOpen must be a function, got "+t);if("function"!=typeof n)throw new TypeError("Must provide an `onItem` callback");return this.instance.subscribeResuming(l({},r,{initialEventId:r.lastItemId,path:"feeds/"+this.feedId+"/items"+s({previous_items:r.previousItems}),tokenProvider:this.readTokenProvider,listeners:{onEvent:function(e){if(0===e.body.type&&t)t(e.body.data);else if(1===e.body.type&&n)n(e.body.data);else if(1<e.body.type)throw new TypeError("Unsupported event type '"+e.body.type+"'")},onSubscribe:r.onSubscribe,onRetrying:r.onRetrying,onError:r.onError,onEnd:r.onEnd}}))}},{key:"paginate",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.cursor,n=e.limit,r=void 0===n?50:n;return i(this.instance.request({method:"GET",path:"feeds/"+this.feedId+"/items"+s({cursor:t,limit:r}),tokenProvider:this.readTokenProvider}))}}]),o}(),f=/^[a-zA-Z0-9-]+$/,g=function(){function r(e){var t=e.authEndpoint,n=e.authData;h(this,r),this.authEndpoint=t,this.authData=n}return p(r,[{key:"fetchToken",value:function(){var t=this;return this.cacheIsStale?this.makeAuthRequest().then(function(e){return t.cache(e.access_token,e.expires_in),t.cachedToken}):Promise.resolve(this.cachedToken)}},{key:"cache",value:function(e,t){this.cachedToken=e,this.cacheValidUntil=a()+t-600}},{key:"makeAuthRequest",value:function(){var r=this;if("string"!=typeof this.authEndpoint)throw new TypeError("Expected authEndpoint to be a string, but got "+this.authEndpoint+". Please provide an authEndpoint to access private feeds. (See http://docs.pusher.com/feeds/concepts/private-feeds/)");return new Promise(function(e,t){var n=new XMLHttpRequest;n.open("POST",r.authEndpoint),n.timeout=3e4,n.onload=function(){200===n.status?e(JSON.parse(n.responseText)):t(new Error("Couldn't fetch token from "+r.authEndpoint+"; got "+n.status+" "+n.statusText+"."))},n.ontimeout=function(){t(new Error("Request timed out while fetching token from "+r.authEndpoint))},n.setRequestHeader("content-type","application/x-www-form-urlencoded"),n.send(o(l({},r.authData,{grant_type:"client_credentials"})))})}},{key:"cacheIsStale",get:function(){return!this.cachedToken||a()>this.cacheValidUntil}}]),r}();return function(){function u(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.authData,n=void 0===t?{}:t,r=e.authEndpoint,o=e.host,i=e.instanceLocator,s=e.logLevel,a=e.logger;h(this,u),this.authData=n,this.authEndpoint=r,this.listTokenProvider=new g({authEndpoint:this.authEndpoint,authData:l({},this.authData,{path:"feeds",action:"READ"})}),this.firehoseTokenProvider=new g({authEndpoint:this.authEndpoint,authData:l({},this.authData,{path:"firehose/items",action:"READ"})}),!a&&s&&(a=new c.ConsoleLogger(s)),this.instance=new c.Instance({host:o,locator:i,logger:a,serviceName:"feeds",serviceVersion:"v1"})}return p(u,[{key:"list",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.prefix,n=e.limit;return i(this.instance.request({method:"GET",path:"feeds"+s({prefix:t,limit:n}),tokenProvider:this.listTokenProvider}))}},{key:"feed",value:function(e){if(!e||!e.match(f))throw new TypeError("Invalid feedId: "+e);var t=e.startsWith("private-")?new g({authEndpoint:this.authEndpoint,authData:l({},this.authData,{path:"feeds/"+e+"/items",action:"READ"})}):null;return new r({instance:this.instance,feedId:e,readTokenProvider:t})}},{key:"firehose",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.onPublish,n=e.onSubscribe,r=e.onUnsubscribe,o=d(e,["onPublish","onSubscribe","onUnsubscribe"]);!function(t){var e=Object.keys(t).filter(function(e){return void 0!==t[e]}).map(function(e){return{name:e,callback:t[e]}});if(e.forEach(function(e){var t=e.name,n=e.callback;if("function"!=typeof n)throw new TypeError(t+" must be a function, got "+n)}),0===e.length)throw new TypeError("Must provide at least one of onPublish, onSubscribe, or onUnsubscribe")}({onPublish:t,onSubscribe:n,onUnsubscribe:r});return this.instance.subscribeNonResuming(l({},o,{path:"firehose/items",tokenProvider:this.firehoseTokenProvider,listeners:{onEvent:function(e){if(0===e.body.type&&t)t(e.body.data);else if(1===e.body.type&&n)n(e.body.data);else if(2===e.body.type&&r)r(e.body.data);else if(2<e.body.type)throw new TypeError("Unsupported firehose event type '"+e.body.type+"'")},onOpen:o.onOpen,onSubscribe:o.onSubscribe,onError:o.onError,onEnd:o.onEnd}}))}}]),u}()});
//# sourceMappingURL=pusher-feeds-client.js.map
